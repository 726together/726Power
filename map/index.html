<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>èŠ±è“®å€åŸŸç®¡ç† Firebase (å…§éƒ¨ä½¿ç”¨)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
<style>
  html, body, #map {
    height: 100%;
    margin: 0; padding: 0;
  }
  body {
    display: flex;
    flex-direction: column;
    height: 100vh;
    font-size: 16px;
  }
  #header {
    background-color: #3388ff;
    color: white;
    padding: 12px 16px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
  }
  #header button {
    background: white;
    border: none;
    border-radius: 6px;
    color: #3388ff;
    font-weight: bold;
    padding: 8px 14px;
    font-size: 1rem;
    cursor: pointer;
  }
  #zone-list {
    display: flex;
    overflow-x: auto;
    background: #f0f0f0;
    padding: 8px 10px;
    margin: 0;
    list-style: none;
    border-bottom: 1px solid #ccc;
  }
  #zone-list li {
    padding: 8px 14px;
    margin-right: 10px;
    background: #ddd;
    border-radius: 24px;
    white-space: nowrap;
    cursor: default;
    user-select: none;
    flex-shrink: 0;
    transition: background-color 0.3s;
    display: flex;
    align-items: center;
  }
  #zone-list li.selected {
    background: #005bbb;
    color: white;
  }
  #zone-list li span {
    flex-grow: 1;
    cursor: pointer;
  }
  #zone-list li button {
    margin-left: 8px;
    cursor: pointer;
    border: none;
    background: none;
    font-size: 1.1rem;
    line-height: 1;
    user-select: none;
  }
  #map {
    flex-grow: 1;
  }
  #loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.3);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #loading-overlay.show {
    display: flex;
  }
  #loading-spinner {
    width: 50px;
    height: 50px;
    border: 6px solid #f3f3f3;
    border-top: 6px solid #3388ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
  }  

  #header-left {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  #search-input {
    padding: 6px 10px;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
  }

  #search-btn {
    background: white;
    border: none;
    border-radius: 6px;
    color: #3388ff;
    font-weight: bold;
    padding: 8px 14px;
    font-size: 1rem;
    cursor: pointer;
  }

  /* æ–°å¢é¡è‰²é¸æ“‡å™¨æ¨£å¼ */
  #color-picker-container {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }
  .color-option {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
  }
  .color-option.selected {
    border-color: black;
  }
  #custom-color {
    width: 30px;
    height: 30px;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  @media (max-width: 600px) {
    #header {
      flex-wrap: wrap;
      gap: 10px;
    }
    #header-left {
      width: 100%;
      justify-content: center;
    }
    #search-input {
      width: 70vw;
    }
  }
</style>
</head>
<body>
<div id="header">
  <div id="header-left">
    <input type="text" id="search-input" placeholder="æœå°‹åœ°å€..." />
    <button id="search-btn">æœå°‹</button>
    <div id="color-picker-container" title="é¸æ“‡å€åŸŸé¡è‰²" aria-label="å€åŸŸé¡è‰²é¸æ“‡å™¨" role="list">
      <!-- 8è‰²åŠè‡ªè¨‚è‰²æœƒå‹•æ…‹ç”¢ç”Ÿ -->
    </div>
  </div>
  <div>èŠ±è“®å€åŸŸç®¡ç†</div>
  <button id="add-region-btn">æ–°å¢å€åŸŸ</button>
  <button onclick="locateUser()">ğŸ“ å–å¾—æˆ‘çš„ä½ç½®</button>
</div>
<ul id="zone-list"></ul>
<div id="map"></div>

<!-- Firebase App -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<!-- Firebase Firestore -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
  // å…ƒä»¶æŠ“å–
  const searchInput = document.getElementById('search-input');
  const searchBtn = document.getElementById('search-btn');
  const zoneList = document.getElementById('zone-list');
  const addRegionBtn = document.getElementById('add-region-btn');
  const colorPickerContainer = document.getElementById('color-picker-container');

  // Firebase åˆå§‹åŒ–
  const firebaseConfig = {
    apiKey: "AIzaSyBFE6Zc_bhLvS4Kg9HkdPN9v8SVna3e6rQ",
    authDomain: "map-1b22b.firebaseapp.com",
    projectId: "map-1b22b",
    storageBucket: "map-1b22b.firebasestorage.app",
    messagingSenderId: "238409334801",
    appId: "1:238409334801:web:bd9f6d9048ecc6663db1b0",
    measurementId: "G-K19VB9YY2F"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ç”¢ç”Ÿ UUID
  function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // åœ°åœ–åˆå§‹åŒ–
  const map = L.map('map').setView([23.974, 121.614], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          L.marker([lat, lng]).addTo(map).bindPopup("ä½ çš„ä½ç½®");
        },
        (err) => alert("ç„¡æ³•å–å¾—ä½ç½®ï¼š" + err.message)
      );
    } else {
      alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚");
  }
  function locateUser() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          L.marker([lat, lng]).addTo(map).bindPopup("ä½ çš„ä½ç½®").openPopup();
          map.setView([lat, lng], 16);
        },
        (err) => alert("ç„¡æ³•å–å¾—ä½ç½®ï¼š" + err.message)
      );
    } else {
      alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚");
    }
  }
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // ç¹ªåœ–æ§åˆ¶å™¨
  const drawControl = new L.Control.Draw({
    edit: {
      featureGroup: drawnItems,
      remove: true
    },
    draw: {
      polygon: true,
      rectangle: true,
      circle: false,
      marker: false,
      circlemarker: false,
      polyline: false
    }
  });
  map.addControl(drawControl);

  // 8ç¨®é è¨­é¡è‰²
  const defaultColors = [
    '#e6194b', // ç´…
    '#3cb44b', // ç¶ 
    '#ffe119', // é»ƒ
    '#4363d8', // è—
    '#f58231', // æ©˜
    '#911eb4', // ç´«
    '#46f0f0', // è—ç¶ 
    '#f032e6'  // ç²‰
  ];
  let selectedColor = defaultColors[0]; // é è¨­ç¬¬ä¸€è‰²

  // å‹•æ…‹ç”¢ç”Ÿé¡è‰²é¸æ“‡å™¨ï¼ˆåœ“é» + color inputï¼‰
  function renderColorPicker() {
    colorPickerContainer.innerHTML = '';
    defaultColors.forEach(color => {
      const div = document.createElement('div');
      div.className = 'color-option';
      div.style.backgroundColor = color;
      if (color === selectedColor) div.classList.add('selected');
      div.setAttribute('role', 'listitem');
      div.setAttribute('aria-label', `é¡è‰²é¸é … ${color}`);
      div.tabIndex = 0;
      div.onclick = () => selectColor(color, div);
      div.onkeydown = e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          selectColor(color, div);
        }
      };
      colorPickerContainer.appendChild(div);
    });
    // è‡ªè¨‚é¡è‰² input
    const customInput = document.createElement('input');
    customInput.type = 'color';
    customInput.id = 'custom-color';
    customInput.title = 'è‡ªè¨‚é¡è‰²';
    customInput.value = selectedColor;
    customInput.oninput = () => {
      selectedColor = customInput.value;
      // å–æ¶ˆæ‰€æœ‰é è¨­è‰²çš„é¸ä¸­
      document.querySelectorAll('.color-option').forEach(e => e.classList.remove('selected'));
    };
    colorPickerContainer.appendChild(customInput);
  }

  function selectColor(color, div) {
    selectedColor = color;
    document.querySelectorAll('.color-option').forEach(e => e.classList.remove('selected'));
    div.classList.add('selected');
    // ä¹Ÿæ›´æ–°è‡ªè¨‚è‰²input
    const customInput = document.getElementById('custom-color');
    if (customInput) customInput.value = color;
  }

  renderColorPicker();

  let regions = [];
  let selectedId = null;

  // render å€åŸŸåˆ—è¡¨
  function renderList() {
    zoneList.innerHTML = '';
    regions.forEach(region => {
      const li = document.createElement('li');
      li.dataset.id = region.id;

      // é¡¯ç¤ºè‰²å¡Š
      const colorDot = document.createElement('span');
      colorDot.style.display = 'inline-block';
      colorDot.style.width = '14px';
      colorDot.style.height = '14px';
      colorDot.style.marginRight = '8px';
      colorDot.style.backgroundColor = region.color || defaultColors[0];
      colorDot.style.borderRadius = '50%';
      li.appendChild(colorDot);

      // åç¨±éƒ¨åˆ†
      const nameSpan = document.createElement('span');
      nameSpan.textContent = region.name;
      nameSpan.style.cursor = 'pointer';
      nameSpan.onclick = () => {
        selectedId = region.id;
        highlightRegion(region.id);
        fitRegion(region.id);
        renderList();
      };
      li.appendChild(nameSpan);

      // ç·¨è¼¯æŒ‰éˆ•
      const editBtn = document.createElement('button');
      editBtn.textContent = 'âœï¸';
      editBtn.title = 'ä¿®æ”¹åç¨±èˆ‡é¡è‰²';
      editBtn.onclick = async (e) => {
        e.stopPropagation();
        const newName = prompt('ä¿®æ”¹å€åŸŸåç¨±', region.name);
        if (newName === null) return;

        // é¡è‰²é¸æ“‡æç¤º (ç”¨ prompt ç°¡æ˜“å¯¦ä½œï¼Œæˆ–æ”¹æˆæ›´å¥½çš„UI)
        const newColor = selectedColor;

        if (newName.trim() === '' || !/^#([0-9a-fA-F]{6})$/.test(newColor.trim())) {
          alert('åç¨±ä¸å¯ç©ºç™½ï¼Œé¡è‰²è«‹è¼¸å…¥æ­£ç¢ºçš„#å…­ä½è‰²ç¢¼');
          return;
        }
        const loadingOverlay = document.getElementById('loading-overlay');
        try {
          loadingOverlay.classList.add('show'); 
          await db.collection('regions').doc(region.id).update({
            name: newName.trim(),
            color: newColor.trim(),
            lastUpdated: Date.now(),
          });
        } catch (err) {
          alert('ä¿®æ”¹å¤±æ•—ï¼š' + err);
        } finally {
          loadingOverlay.classList.remove('show');
        }
      };
      li.appendChild(editBtn);

      // åˆªé™¤æŒ‰éˆ•
      const delBtn = document.createElement('button');
      delBtn.textContent = 'ğŸ—‘ï¸';
      delBtn.title = 'åˆªé™¤å€åŸŸ';
      delBtn.onclick = async (e) => {
        e.stopPropagation();
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤å€åŸŸã€Œ${region.name}ã€å—ï¼Ÿ`)) return;
        const loadingOverlay = document.getElementById('loading-overlay');
        try {
          loadingOverlay.classList.add('show'); 
          await db.collection('regions').doc(region.id).delete();
          if (selectedId === region.id) selectedId = null;
        } catch (err) {
          alert('åˆªé™¤å¤±æ•—ï¼š' + err);
        } finally {
          loadingOverlay.classList.remove('show');
        }
      };
      li.appendChild(delBtn);

      if (region.id === selectedId) li.classList.add('selected');
      zoneList.appendChild(li);
    });
  }

  // ä»¥é¡è‰²é«˜äº®é¸å–çš„å€åŸŸï¼Œå…¶é¤˜è¨­å›é è¨­é¡è‰²
  function highlightRegion(id) {
    drawnItems.eachLayer(layer => {
      if (layer._leaflet_id === id) {
        layer.setStyle({ color: 'red', weight: 4 });
        layer.bringToFront();
        if (layer.openPopup) layer.openPopup();
      } else {
        const reg = regions.find(r => r.id === layer._leaflet_id);
        const color = reg && reg.color ? reg.color : defaultColors[0];
        layer.setStyle({ color: color, weight: 2 });
        if (layer.closePopup) layer.closePopup();
      }
    });
  }

  // æ”¾å¤§é¸å–å€åŸŸ
  function fitRegion(id) {
    const layer = drawnItems.getLayer(id);
    if (layer) map.fitBounds(layer.getBounds());
  }

  // æ ¹æ“šè³‡æ–™å»ºç«‹ Leaflet Layer ä¸¦å¥—è‰²
  function createLayerFromRegion(region) {
    let geojson;
    try {
      geojson = JSON.parse(region.geojsonStr);
    } catch(e) {
      alert('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æ GeoJSON');
      return;
    }
    const layer = L.geoJSON(geojson, { 
      style: { color: region.color || defaultColors[0], weight: 2 }
    });
    layer.bindPopup(region.name);
    layer._leaflet_id = region.id;
    drawnItems.addLayer(layer);
    return layer;
  }

  // ç›£è½ Firebase Firestore å€åŸŸè³‡æ–™è®ŠåŒ–
  db.collection('regions').onSnapshot(snapshot => {
    drawnItems.clearLayers();
    regions = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      const region = {
        id: doc.id,
        name: data.name,
        geojsonStr: data.geojsonStr,
        color: data.color || defaultColors[0]
      };
      regions.push(region);
      createLayerFromRegion(region);
    });
    renderList();
  });

  // æ–°å¢å€åŸŸæ™‚ï¼Œå­˜é¡è‰²
  map.on(L.Draw.Event.CREATED, async e => {
    const layer = e.layer;
    let name = prompt('è«‹è¼¸å…¥å€åŸŸåç¨±');
    if (!name) return;

    // é¡è‰²ä½¿ç”¨ç•¶ä¸‹é¸æ“‡é¡è‰²
    let color = selectedColor;

    // GeoJSON å­—ä¸²
    const geojsonRaw = layer.toGeoJSON();
    const geojsonStr = JSON.stringify(geojsonRaw);
    const loadingOverlay = document.getElementById('loading-overlay');
    try {
      loadingOverlay.classList.add('show'); 
      await db.collection('regions').doc(generateUUID()).set({
        name,
        geojsonStr,
        color,
        lastUpdated: Date.now(),
      });
    } catch (err) {
      alert('æ–°å¢å¤±æ•—: ' + err);
    } finally {
      loadingOverlay.classList.remove('show');
    }
  });

  // åˆªé™¤æ™‚åŒæ­¥åˆªé™¤ Firebase
  map.on('draw:deleted', async e => {
    const layers = e.layers;
    const loadingOverlay = document.getElementById('loading-overlay');
    try {
      loadingOverlay.classList.add('show'); 
      const batch = db.batch();
      layers.eachLayer(layer => {
        const id = layer._leaflet_id;
        const docRef = db.collection('regions').doc(id);
        batch.delete(docRef);
      });
      await batch.commit();
      selectedId = null;
    } catch (err) {
      alert('åˆªé™¤å¤±æ•—: ' + err);
    } finally {
      loadingOverlay.classList.remove('show');
    }
  });

  // åœ°åœ–ç©ºç™½é»æ“Šå–æ¶ˆé¸å–
  map.on('click', e => {
    if (!e.originalEvent._simulated) {
      selectedId = null;
      highlightRegion(null);
      renderList();
    }
  });

  // é»æ“Šç¹ªè£½ç‰©ä»¶é¸å–
  drawnItems.on('click', e => {
    selectedId = e.layer._leaflet_id;
    highlightRegion(selectedId);
    renderList();
  });

  // æ–°å¢å€åŸŸæŒ‰éˆ•æé†’ä½¿ç”¨ç¹ªè£½å·¥å…·
  addRegionBtn.onclick = () => {
    alert('è«‹ä½¿ç”¨åœ°åœ–å·¦ä¸Šè§’ç¹ªè£½å·¥å…·æ–°å¢å€åŸŸ');
  };

  // åœ°å€æœå°‹åŠŸèƒ½
  searchBtn.addEventListener('click', async () => {
    const keyword = searchInput.value.trim();
    if (!keyword) return alert("è«‹è¼¸å…¥åœ°å€é—œéµå­—");
    try {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(keyword)}`;
      const res = await fetch(url, { headers: { 'Accept-Language': 'zh-TW' } });
      const results = await res.json();
      if (results.length === 0) {
        alert('æŸ¥ç„¡çµæœ');
        return;
      }
      const place = results[0];
      const lat = parseFloat(place.lat);
      const lon = parseFloat(place.lon);
      map.setView([lat, lon], 16);
    } catch (err) {
      alert('æœå°‹å¤±æ•—ï¼š' + err.message);
    }
  });
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') searchBtn.click();
  });
</script>

<div id="loading-overlay">
  <div id="loading-spinner"></div>
</div>
</body>
</html>
